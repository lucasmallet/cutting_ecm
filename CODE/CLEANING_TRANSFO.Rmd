---
title: "Prelim_results"
output: html_document
date: "2023-03-06"
---
# install packages
install.packages("devtools")
devtools::install_github("adrientaudiere/MiscMetabar") -> a installer 
devtools::install_github("jokergoo/circlize")

#others libraries
library(amplicon)
library (iNEXT) # for rarefaction curves, but with a simple matrix
library (MicrobiotaProcess)

```{r packages}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(vegan)
library(phyloseq)
library(forcats)
library(MiscMetabar)
library(circlize)
library(ggVennDiagram)
library(phyloseq.extended)

library (microbiomeutilities)
```

```{r functions}
ggrare <- function(physeq_object, step = 10, label = NULL, color = NULL, plot = TRUE, parallel = FALSE, se = TRUE) {

  x <- methods::as(phyloseq::otu_table(physeq_object), "matrix")
  if (phyloseq::taxa_are_rows(physeq_object)) { x <- t(x) }

  ## This script is adapted from vegan `rarecurve` function
  tot <- rowSums(x)
  S <- rowSums(x > 0)
  nr <- nrow(x)

  rarefun <- function(i) {
    cat(paste("rarefying sample", rownames(x)[i]), sep = "\n")
    n <- seq(1, tot[i], by = step)
    if (n[length(n)] != tot[i]) {
      n <- c(n, tot[i])
    }
    y <- vegan::rarefy(x[i, ,drop = FALSE], n, se = se)
    if (nrow(y) != 1) {
      rownames(y) <- c(".S", ".se")
      return(data.frame(t(y), Size = n, Sample = rownames(x)[i]))
    } else {
      return(data.frame(.S = y[1, ], Size = n, Sample = rownames(x)[i]))
    }
  }
  if (parallel) {
    out <- parallel::mclapply(seq_len(nr), rarefun, mc.preschedule = FALSE)
  } else {
    out <- lapply(seq_len(nr), rarefun)
  }
  df <- do.call(rbind, out)

  # Get sample data
  if (!is.null(phyloseq::sample_data(physeq_object, FALSE))) {
    sdf <- methods::as(phyloseq::sample_data(physeq_object), "data.frame")
    sdf$Sample <- rownames(sdf)
    data <- merge(df, sdf, by = "Sample")
    labels <- data.frame(x = tot, y = S, Sample = rownames(x))
    labels <- merge(labels, sdf, by = "Sample")
  }

  # Add, any custom-supplied plot-mapped variables
  if ( length(color) > 1 ) {
    data$color <- color
    names(data)[names(data) == "color"] <- deparse(substitute(color))
    color <- deparse(substitute(color))
  }

  if ( length(label) > 1 ) {
    labels$label <- label
    names(labels)[names(labels) == "label"] <- deparse(substitute(label))
    label <- deparse(substitute(label))
  }

  p <- ggplot2::ggplot(data = data,
                       ggplot2::aes_string(x = "Size",
                                           y = ".S",
                                           group = "Sample",
                                           color = color))

  p <- p + ggplot2::labs(x = "Sequence Sample Size (Nb of reads)", y = "Number of ASV/OTU occurence")

  if (!is.null(label)) {
    p <- p + ggplot2::geom_text(data = labels,
                                ggplot2::aes_string(x = "x",
                                                    y = "y",
                                                    label = label,
                                                    color = color),
                       size = 4, hjust = 0)
  }

  p <- p + ggplot2::geom_line()
  if (se) { ## add standard error if available
    p <- p +
      ggplot2::geom_ribbon(ggplot2::aes_string(ymin = ".S - .se",
                                               ymax = ".S + .se",
                                               color = NULL,
                                               fill = color),
                           alpha = 0.2)
  }
  if (plot) {
    plot(p)
  }
  invisible(p)
}

rcurve <- function(physeq, subsamp = 10^c(1:5), trim = TRUE, add_sample_data = TRUE){
    
    otu <- otu_table(physeq)
    if(!taxa_are_rows(physeq)){
        otu <- t(otu)
    }
    colS <- colSums(otu)
    
    pb <- txtProgressBar(min = 0, max = length(subsamp), style = 3)
    rars <- list()
    for(i in seq_along(subsamp)){
        setTxtProgressBar(pb, i)
        rars[[i]] <- vegan::rarefy(otu, sample = subsamp[i], MARGIN = 2)
    }
    mat <- do.call(cbind, rars)
    
    if(trim){
        mat_bool <- sapply(subsamp, function(i) sapply(colS, function(j) i <= j))
        mat_new <- mat * mat_bool
        mat_new[mat_new == 0] <- NA
    } else {
        mat_new <- mat
    }
    colnames(mat_new) <- subsamp
    
    # To a data.frame
    df <- as.data.frame.table(mat_new)
    colnames(df) <- c("Sample", "Reads", "Richness")
    df$Reads <- as.numeric(as.character(df$Reads))
    
    if(trim){
        df <- na.omit(df)
    }

    # Add sample data
    if(add_sample_data){
        samp <- sample_data(physeq)
        df2 <- merge(df, samp, by = "Sample", by.y = "row.names")
        return(df2)
    } else {
        return(df)
    }
    
}
```

```{r importation}
# tax-eco table 
## only ECM and saprotrophs
setwd("H:/REDACTION/RESULTS/cutting_ecm/TRANSF_DATA2")
taxeco <- read.table("tax_table.txt",header=T,sep="\t") # change #N/A in excel in NA
length(taxeco)
taxeco[,c(3:length(taxeco))] <- lapply(taxeco[,c(3:length(taxeco))], as.factor) 
rownames(taxeco) <- taxeco$Cluster_ID

# otu table
otu <- read.table("otu_table.txt",header=F,sep="\t",na.strings = T) 
otu = setNames(data.frame(t(otu[,-1])), otu[,1]) # transpose + 1st column (ie samples set as header
## samples = columns, otu abundance = rows
colnames(otu)[1] <- "Cluster_ID" # after transposing, resolving pb with headers
nrow(otu)

# sample data
sam <- read.table("sample_table.txt",header=T,sep="\t",na.strings = T) 
sam[sam==""] <- NA # filling the blanck by NAs
length(sam)
rownames(sam) <- sam$sample_id # after transposing, resolving pb with headers

# subset guilds (saprotroph - ectomycorrizal)
ecm <- subset(taxeco,taxeco$primary_lifestyle=="ectomycorrhizal") %>% arrange(desc(Cluster_Size))
sapr <- subset(taxeco,taxeco$primary_lifestyle!="ectomycorrhizal")
```

```{r supress OTU non ecto/no sapro}
otu_filtered <- merge(otu, taxeco, by = "Cluster_ID",sort=T) # using taxeco (already filtered by ecm and sapr) to filter otu from other guilds

# semi_join(otu, taxeco, by = "Cluster_ID") # not working because not similar df


sam_filtered <- sam[sam$sample_id %in% colnames(otu_filtered),] # keep the rows (ie samples) that appear in others tables
# if 0 obs, in df -> check column names (may differs among datasets)
rownames(sam_filtered) <- sam_filtered[,1]

rownames(otu_filtered) <- otu_filtered[,1] 
which(colnames(otu_filtered)=="sPCR_neg_2") # merge 2 dataframe, but we just want to keep otu (with the good rows)
otu_filtered2 <- subset(otu_filtered[c(1:513),c(2:162),])
taxeco2 <- subset(taxeco[,c(3:length(taxeco)),]) 
```

```{r trasnforming df into matrixes}
# useful functions
## str() 
## class()
## dplyr::join()

# transforming dataframes into matrixes for phyloseq functions (otu,tax)
otu_filtered3 <- matrix(as.numeric(unlist(otu_filtered2)), 
                        ncol = ncol(otu_filtered2),
                        nrow = nrow(otu_filtered2))
taxeco3 <- matrix(as.character(unlist(taxeco2)), 
                        ncol = ncol(taxeco2),
                        nrow = nrow(taxeco2))

# attributing rownanmes after being deleted from matrix transformation
rownames(otu_filtered3) <- rownames(otu_filtered2)
colnames(otu_filtered3) <- colnames(otu_filtered2)
rownames(taxeco3) <- rownames(taxeco2)
colnames(taxeco3) <- colnames(taxeco2)
```

```{r otu <1% suppresion}
# transforming abundance matrix to relative
otu_relative <- prop.table(otu_filtered3, margin=2) # margin = 2 -> column sum and relative abundances

# verification
## rowsum
verif_sum <- colSums(otu_relative) %>% summary() %>% print() # ok if 1 and some NAs

## for 3 - c10 c100
### total read sample3 =744 
relat_3c10 <- (19/744) %>% print()
relat_3c100 <- (25/744) %>% print() 
which(otu_relative==relat_3c10, arr.ind = T)
which(otu_relative==relat_3c100, arr.ind = T) # good 

# creating a new matrix where <1% reads are deleted 
otu_sup0.01 <- ifelse(otu_relative>0.01,otu_filtered3,0) 
```

```{r physeq objects}
# creating the physeq objects 
otu_phy <- otu_table(otu_sup0.01, taxa_are_rows = TRUE)
taxeco_phy <- phyloseq::tax_table(taxeco3)
sam_phy <- sample_data(sam_filtered)

# general physeq object
physeq <- phyloseq(otu_phy,taxeco_phy,sam_phy) 
sample_names(physeq) # missing the controls and negatives
```

```{r physeq susbsets}
# subsetting based on sites and guilds 
ecm_phy <- subset_taxa(physeq, primary_lifestyle=="ectomycorrhizal") 
ecm_phy <- subset_samples(ecm_phy, (ecm_phy@sam_data$site!="control")) %>% 
clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = F)
sapr_phy <- subset_taxa(physeq, primary_lifestyle!="ectomycorrhizal")

fanga <- subset_samples(physeq, physeq@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala <- subset_samples(physeq, physeq@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5 <- subset_samples(physeq, physeq@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
  
fanga_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

fanga_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

# abundance -> boolean
fanga_ecm_pa <- as_binary_otu_table(fanga_ecm) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_ecm_pa <- as_binary_otu_table(hala_ecm) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T) 
hala5_ecm_pa <- as_binary_otu_table(hala5_ecm) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

fanga_sapr_pa <- as_binary_otu_table(fanga_sapr) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_sapr_pa <- as_binary_otu_table(hala_sapr) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5_sapr_pa <- as_binary_otu_table(hala5_sapr) %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
```

```{r transfo variables}
fanga_sam <- lapply(fanga@sam_data, as.factor) %>% as.data.frame()
hala_sam <- lapply(hala@sam_data, as.factor) %>% as.data.frame()
hala5_sam <- lapply(hala5@sam_data, as.factor) %>% as.data.frame()

sample_data(fanga_ecm)$year_factor <- as.factor(sample_data(fanga_ecm)$year)
sample_data(hala_ecm)$year_factor <- as.factor(sample_data(hala_ecm)$year)
```

```{r matrix simple otu-sam}
fanga_ecm_samotu <- data.frame(fanga_ecm@sam_data,t(fanga_ecm@otu_table)) 
hala_ecm_samotu <- data.frame(hala_ecm@sam_data,t(hala_ecm@otu_table))

hala_ecm_sam_df <- lapply(hala_ecm_samotu[,1:9], as.factor) %>% as.data.frame()
hala_ecm_otu_df <- lapply(hala_ecm_samotu[,10:length(hala_ecm_samotu)], as.numeric) %>% as.data.frame() 
hala_ecm_samotu <- cbind(hala_ecm_samotu_fact,hala_ecm_otu_df)

hala5_ecm_samotu <- data.frame(hala5_ecm@sam_data,t(hala5_ecm@otu_table))
```

```{r transposing otu table in physq object for hill_pq}
hala_ecm_otu_t <- t(hala_ecm@otu_table)
hala_ecm_sam <- hala_ecm@sam_data
hala_ecm_tax <- hala_ecm@tax_table
hala_ecm_t <- phyloseq(hala_ecm_otu_t,hala_ecm_sam,hala_ecm_tax)

hala5_ecm_otu_t <- t(hala5_ecm@otu_table)
hala5_ecm_sam <- hala5_ecm@sam_data
hala5_ecm_tax <- hala5_ecm@tax_table
hala5_ecm_t <- phyloseq(hala5_ecm_otu_t,hala5_ecm_sam,hala5_ecm_tax)

fanga_ecm_otu_t <- t(fanga_ecm@otu_table)
fanga_ecm_sam <- fanga_ecm@sam_data
fanga_ecm_tax <- fanga_ecm@tax_table
fanga_ecm_t <- phyloseq(fanga_ecm_otu_t,fanga_ecm_sam,fanga_ecm_tax)

```

```{r pattern with edges: transforming data}
print(hala_ecm@sam_data)
factor(hala_ecm@sam_data$specification) %>% levels()

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("edge_north"="edge", 
                             "edge_south"="edge",
                             "kant_norra"="edge", 
                             "middle_lower"="middle", 
                             "middle_upper"="middle",
                             "midle"="middle"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()

hala_ecm@sam_data <- within(hala_ecm@sam_data, specification[specification=="middle" & treatment=="forest"] <- "FOR_middle") 

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("middle"="CC_middle", 
                             "edge"="CC_edge"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()
```
