---
title: "Prelim_results"
output: html_document
date: "2023-03-06"
---
*LIBRARY*
```{r packages}
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(dplyr) # A Grammar of Data Manipulation
library(tidyverse) # A Grammar of Data Manipulation
library(vegan) # ecological statistical analysis
library(phyloseq) # Handling and analysis of high-throughput microbiome census data 
library(forcats) # Tools for Working with Categorical Variables
library(MiscMetabar) # Analyze and visualize metabarcoding data
library(circlize) # circular visualization
library(ggVennDiagram) # venn diagrams 
library(phyloseq.extended) # phyloseq packages with more options
library (microbiomeutilities) # for rarefaction curves
library("multcompView") # Visualizations of Paired Comparisons
library(plyr)
library(pals)
```
*DATA IMPORTATION AND MODIF* 
```{r raw_data}
setwd("H:/REDACTION/RESULTS/cutting_ecm/TRANSF_DATA2") 
#data run
run_data <- read.table("run_data.txt",header=T,sep="\t",na.strings=T,dec=".")
colnames(run_data)

# all clusters
raw_clust <- read.table("raw_clusters.txt",header=T,sep="\t",na.strings=T,dec=".") %>% 
arrange(desc(Cluster_Size)) # importing and arrange by decreasing cluster size
raw_clust[raw_clust==""] <- NA # putting NA when empty
raw_clust[,4] <- as.character(raw_clust[,4]) # reference as.character
raw_clust$Cluster_ID <- gsub('scata5670_','c',raw_clust$Cluster_ID) # replace character occurence in all cells
rownames(raw_clust) <- raw_clust$Cluster_ID
order <- raw_clust$Cluster_ID 
order <- gsub('c','',raw_clust$Cluster_ID) # creating a vector order so we can arrange later
raw_clust <- data.frame(cbind(order, raw_clust))
raw_clust[,"order"] <- as.numeric(raw_clust[,"order"])

# subsetting fungi X non-fungi
raw_f_clust <- subset(raw_clust,!grepl("PLANT|NF",raw_clust[,5]))
raw_nf_clust <- subset(raw_clust,grepl("PLANT|NF",raw_clust[,5]))
```
```{r tax-eco table }
# only the 1st 1000 clusters 
taxeco <- read.table("tax_table.txt",header=T,sep="\t") # change #N/A in excel in NA
length(taxeco) # number of columns 
length(rownames(taxeco)) # number of rows (ie clusters, 1st 1000 fungi)
taxeco[,c(3:length(taxeco))] <- lapply(taxeco[,c(3:length(taxeco))], as.factor) 
rownames(taxeco) <- taxeco$Cluster_ID # rownames of corresponding clusters
taxeco1 <- subset(taxeco[,c(3:length(taxeco)),]) 

taxeco2 <- subset(taxeco[,c(3:length(taxeco)),]) 
taxeco2 <- matrix(as.character(unlist(taxeco2)),
              ncol = ncol(taxeco2),
              nrow = nrow(taxeco2))
```
```{r subsetting taxtable}
id_taxeco <- raw_f_clust %>%
  filter(Cluster_ID %in% taxeco$Cluster_ID) %>%
  arrange(order) # filtering taxtable identified manually
id_taxeco <- cbind("MANUAL_ID", id_taxeco)

unid_taxeco <- raw_f_clust %>%
  filter(!Cluster_ID %in% taxeco$Cluster_ID) %>%
  arrange(order) # filtering taxtable not identified 

taxeco_f <- dplyr::bind_rows(id_taxeco, unid_taxeco)
colnames(taxeco_f)[1] <- "ID_TYPE"
taxeco_f$ID_TYPE[is.na(taxeco_f$ID_TYPE)] <- "AUTO_ID" 
```

```{r sample data}
# sample data
sam <- read.table("sample_table.txt",header=T,sep="\t",na.strings = T) 
sam_no_match <- read.table("samples_no_match.txt",header=T,sep="\t") 

sam[sam==""] <- NA # filling the blanck by NAs
rownames(sam) <- sam$sample_id # after transposing, resolving pb with headers

# subsetting design samples per site 
sam_hala <- subset(sam, sam$site == "Halasen") # 61 samples
sam_hala5 <- subset(sam, sam$site == "Halasen_p_5") # 29 samples
sam_fanga <- subset(sam, sam$site == "Fangamon") # 69 samples
sam_controls_na <- filter(sam, !site %in% c("Halasen","Halasen_p_5","Fangamon")) # 19 samples (or controls)
```
```{r otu table}
otu <- read.table("otu_table.txt",header=F,sep="\t",na.strings = T) 
otu = setNames(data.frame(t(otu[,-1])), otu[,1]) # transpose + 1st column (ie samples set as header
## samples = columns, otu abundance = rows
colnames(otu)[1] <- "Cluster_ID" # after transposing, resolving pb with headers
nrow(otu) # total number of all clusters (ie fungi ecm or no-ecm, plants)
rownames(otu) <- otu$Cluster_ID
otu <- otu[-1] # deleting 1st column (cluster_id is now in rownames)
colnames(otu)

not_samples_kept <- c("sITS-standard2", "sITS-standard1", "sPCR_neg_1", "sPCR_neg_2", "sQ2", "s49", "s97") # cf MM_RESULTS.Rmd ```{r DESIGN SAMPLES}  to understand how they are found 

samples_kept_pq <- otu[, colnames(otu) %in% not_samples_kept]
otu <- otu[, !(colnames(otu) %in% not_samples_kept)] # suppressing from dataset 



otu1 <- matrix(as.numeric(unlist(otu)),
              ncol = ncol(otu),
              nrow = nrow(otu)) # puting array numeric and transforming in matrix for further functions 

```
```{r row and colnames re-attribution (after being deleted from matrix transfo)}
rownames(otu1) <- rownames(otu)
colnames(otu1) <- colnames(otu)
rownames(taxeco2) <- rownames(taxeco1)
colnames(taxeco2) <- colnames(taxeco1)
```
```{r otu <1% suppresion}
otu_relative <- prop.table(otu1, margin=2) # margin = 2 -> column sum and relative abundances
verif_sum <- colSums(otu_relative) %>% summary() %>% print() # # verification: ok if 1 and some NAs
otu_001 <- ifelse(otu_relative>0.01,otu1,0) # creating a new matrix where <1% reads are deleted
otu_notrarefied <- otu_001
```
```{r hellinger transformation}
otu_hellinger <- sapply(otu_relative, sqrt)
otu_hellinger <- matrix(as.numeric(unlist(otu_hellinger)),
              ncol = ncol(otu_001),
              nrow = nrow(otu_001))
rownames(otu_hellinger) <- rownames(otu_001)
colnames(otu_hellinger) <- colnames(otu_001)
```

```{r otu rarefaction}
otu_t <- t(otu_001)
otu_t <- matrix(as.numeric(unlist(otu_t)),
              ncol = ncol(otu_t),
              nrow = nrow(otu_t))
rownames(otu_t) <- rownames(otu_t)
colnames(otu_t) <- colnames(otu_t)

otu_rarefied <- as.data.frame(rrarefy(otu_t, min(rowSums(otu_t))))
otu_rarefied <- t(otu_rarefied)
otu_rarefied <- matrix(as.numeric(unlist(otu_rarefied)),
              ncol = ncol(otu_rarefied),
              nrow = nrow(otu_rarefied))

rownames(otu_rarefied) <- rownames(otu)
colnames(otu_rarefied) <- colnames(otu)

richness_allc <- specnumber(t(otu_rarefied))
summary(richness_allc)
hist(richness_allc)

reads_sum_per_sample <- rowSums(otu_t) 
summary(reads_sum_per_sample)
hist(reads_sum_per_sample) # rarefying based on the min sample depth (here 419)
low_seqdepth_samples <- which(reads_sum_per_sample < 1108) %>% data.frame() # samples with sequencing depth < 1108 (Q1)
list_low_seqdepth_samples <- dput(as.character(rownames(low_seqdepth_samples))) # convert into the format c(x; y; ...; z)

# View(sam[list_low_seqdepth_samples,])
## check pool 1 2 sequencing depth difference
```

*CREATION OF PHYSEQ OBJECTS*
```{r physeq objects}
# creating the physeq objects 
otu_phy_rarefied <- otu_table(otu_rarefied, taxa_are_rows = TRUE)
otu_phy_notrarefied <- otu_table(otu_notrarefied, taxa_are_rows = TRUE)
otu_phy_hellinger <- otu_table(otu_hellinger, taxa_are_rows = TRUE)
otu_phy_relative <- otu_table(otu_relative, taxa_are_rows = TRUE)
taxeco_phy <- phyloseq::tax_table(taxeco2)
sam_phy <- sample_data(sam)

# general physeq object
physeq <- phyloseq(otu_phy_rarefied,taxeco_phy,sam_phy) 
# otu_phy_rarefied
# otu_phy_notrarefied
# otu_phy_hellinger
# otu_phy_relative
physeq_rarefied <- phyloseq(otu_phy_rarefied,taxeco_phy,sam_phy) 
physeq_notrarefied <- phyloseq(otu_phy_notrarefied,taxeco_phy,sam_phy) 
physeq_hellinger <- phyloseq(otu_phy_hellinger,taxeco_phy,sam_phy) 
physeq_relative <- phyloseq(otu_phy_relative,taxeco_phy,sam_phy) 

sample_names(physeq) # 154 samples, as expected 
```
```{r sequencing depth changing between pool ?}
physeq_notrarefied_p1 <- subset_samples(physeq_notrarefied, physeq_notrarefied@sam_data$pool=="1") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

physeq_notrarefied_p2 <- subset_samples(physeq_notrarefied, physeq_notrarefied@sam_data$pool=="2") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

reads_sum_per_sample <- rowSums(t(physeq_notrarefied@otu_table))
summary(reads_sum_per_sample)
hist(reads_sum_per_sample)

readsp1_sum_per_sample <- rowSums(t(physeq_notrarefied_p1@otu_table))
summary(readsp1_sum_per_sample)
hist(readsp1_sum_per_sample)

readsp2_sum_per_sample <- rowSums(t(physeq_notrarefied_p2@otu_table)) 
summary(readsp2_sum_per_sample)
hist(readsp2_sum_per_sample)

boxplot(reads_sum_per_sample ~ physeq_notrarefied@sam_data$pool)
boxplot(reads_sum_per_sample ~ physeq_notrarefied@sam_data$site)

lm_seq_depth <- lm(reads_sum_per_sample ~ physeq_notrarefied@sam_data$pool + physeq_notrarefied@sam_data$site)
anova(lm_seq_depth)
kruskal.test(reads_sum_per_sample, physeq_notrarefied@sam_data$pool)
```
```{r taxa attribution mistakes}
# reattribution of correct names
physeq@tax_table[physeq@tax_table == "Gautieria_"] <- "Gautieria"
physeq@tax_table[physeq@tax_table == "Piloderma__"] <- "Piloderma"
physeq@tax_table[physeq@tax_table == "Sebacina__"] <- "Sebacina"
physeq@tax_table[physeq@tax_table == "Inocybe_geophylla"] <- "Inocybe_geophylla_(coll.)"
```
```{r susbsets primary}
# subsetting based on sites and guilds 
# CTRL F + remove_empty_samples = T <-> remove_empty_samples = F

ecm_raw <- subset(taxeco,taxeco$primary_lifestyle=="ectomycorrhizal") %>% arrange(desc(Cluster_Size))
sapr_raw <- subset(taxeco,taxeco$primary_lifestyle!="ectomycorrhizal") %>% arrange(desc(Cluster_Size))

ecm_phy <- subset_taxa(physeq, primary_lifestyle=="ectomycorrhizal") 
ecm_phy <- subset_samples(ecm_phy, (ecm_phy@sam_data$site!="control")) %>% 
clean_pq(remove_empty_samples = FALSE,remove_empty_taxa = T, clean_samples_names = F)
sapr_phy <- subset_taxa(physeq, primary_lifestyle!="ectomycorrhizal") %>% 
clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = F)

fanga <- subset_samples(physeq, physeq@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala <- subset_samples(physeq, physeq@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5 <- subset_samples(physeq, physeq@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
  
fanga_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5_ecm <- subset_samples(ecm_phy, ecm_phy@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
```
```{r transforming factor labels}
# hala
print(hala_ecm@sam_data)
factor(hala_ecm@sam_data$specification) %>% levels()

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("edge_north"="edge", 
                             "edge_south"="edge",
                             "kant_norra"="edge", 
                             "middle_lower"="middle", 
                             "middle_upper"="middle",
                             "midle"="middle"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()

hala_ecm@sam_data <- within(hala_ecm@sam_data, specification[specification=="middle" & treatment=="forest"] <- "FOR_middle") 

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("middle"="CC_middle", 
                             "edge"="CC_edge"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()

# hala5
hala5_ecm@sam_data$treatment <- plyr::revalue(hala5_ecm@sam_data$treatment,
                           c("control" = "forest",
                             "p_5" = "thinned"))
as.factor(hala5_ecm@sam_data$treatment) %>% droplevels() %>% levels()

# fanga
fanga_ecm@sam_data$treatment <- plyr::revalue(fanga_ecm@sam_data$treatment,
                           c("forest_control" = "forest",
                             "shelter_burn" = "thinned_burn",
                             "shelter_without_burn" = "thinned_no_burn"))
as.factor(fanga_ecm@sam_data$treatment) %>% droplevels() %>% levels()
```
```{r subsets secondary}
fanga_ecm_12 <- subset_samples(fanga_ecm, fanga_ecm@sam_data$year=="2012") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_ecm_12 <- subset_samples(hala_ecm, hala_ecm@sam_data$year=="2012") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

fanga_ecm_18 <- subset_samples(fanga_ecm, fanga_ecm@sam_data$year=="2018") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_ecm_18 <- subset_samples(hala_ecm, hala_ecm@sam_data$year=="2018") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)

fanga_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Fangamon") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Halasen") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
hala5_sapr <- subset_samples(sapr_phy, sapr_phy@sam_data$site=="Halasen_p_5") %>% clean_pq(remove_empty_samples = T,remove_empty_taxa = T, clean_samples_names = T)
```
*VAR TRANSFO FOR ANALYSIS*
```{r transfo variables}
fanga_sam <- lapply(fanga@sam_data, as.factor) %>% as.data.frame()
hala_sam <- lapply(hala@sam_data, as.factor) %>% as.data.frame()
hala5_sam <- lapply(hala5@sam_data, as.factor) %>% as.data.frame()

sample_data(fanga_ecm)$year_factor <- as.factor(sample_data(fanga_ecm)$year)
sample_data(hala_ecm)$year_factor <- as.factor(sample_data(hala_ecm)$year)

hala5_ecm@sam_data$treatment <- plyr::revalue(hala5_ecm@sam_data$treatment,
                           c("control" = "forest",
                             "p_5" = "thinned"))
as.factor(hala5_ecm@sam_data$treatment) %>% droplevels() %>% levels()

fanga_ecm_12@sam_data$treatment <- plyr::revalue(fanga_ecm_12@sam_data$treatment,
                           c("forest_control" = "forest",
                             "shelter_burn" = "thinned_burn",
                             "shelter_without_burn" = "thinned_no_burn"))
as.factor(fanga_ecm_12@sam_data$treatment) %>% droplevels() %>% levels()

fanga_ecm_18@sam_data$treatment <- plyr::revalue(fanga_ecm_18@sam_data$treatment,
                           c("forest_control" = "forest",
                             "shelter_burn" = "thinned_burn",
                             "shelter_without_burn" = "thinned_no_burn"))
as.factor(fanga_ecm_18@sam_data$treatment) %>% droplevels() %>% levels()
```
```{r transposing otu table in physq object for hill_pq}
hala_ecm_otu_t <- t(hala_ecm@otu_table)
hala_ecm_sam <- hala_ecm@sam_data
hala_ecm_tax <- hala_ecm@tax_table
hala_ecm_t <- phyloseq(hala_ecm_otu_t,hala_ecm_sam,hala_ecm_tax)

hala5_ecm_otu_t <- t(hala5_ecm@otu_table)
hala5_ecm_sam <- hala5_ecm@sam_data
hala5_ecm_tax <- hala5_ecm@tax_table
hala5_ecm_t <- phyloseq(hala5_ecm_otu_t,hala5_ecm_sam,hala5_ecm_tax)

fanga_ecm_otu_t <- t(fanga_ecm@otu_table)
fanga_ecm_sam <- fanga_ecm@sam_data
fanga_ecm_tax <- fanga_ecm@tax_table
fanga_ecm_t <- phyloseq(fanga_ecm_otu_t,fanga_ecm_sam,fanga_ecm_tax)
```
```{r grouping by factor of insterest}
hala_grp_12 <- merge_group(hala_ecm_12, group = "specification",)
hala_grp_18 <- merge_group(hala_ecm_18, group = "specification",)
hala5_grp <- merge_group(hala5_ecm, group = "treatment")
fanga_grp_12 <- merge_group(fanga_ecm_12, group = "treatment")
fanga_grp_18 <- merge_group(fanga_ecm_18, group = "treatment")
```




