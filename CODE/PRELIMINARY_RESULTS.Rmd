---
title: "PRELIMINARY_RESULTS"
output: html_document
date: "2023-03-08"
---
controls: 
alt+o = close all 
shift+alt+o = open all

for ggplot: position = fill -> relative abundance 

# 1 LIBRARIES - PALETTES 
```{r libraries}
library(plyr)
library(pals)
```

```{r dummy graphs}
list_mm <- lsf.str("package:MiscMetabar") 
factor(list_mm)
## to see all functions from a package

# circles physeq
circle_pq(ecm_phy, "site", taxa = "Phylum", add_nb_seq = F,
          grid_col = "darkgrey",
          row_col = c("darkred","#1F78B4","darkgreen"))

sample_names(ecm_phy)
```

```{r color palette}
pal.bands(alphabet, alphabet2, cols25, glasbey, kelly, polychrome, 
  stepped, tol, watlington,
  show.names=FALSE)

funky <- colorRampPalette(c("#A6CEE3","#1F78B4","#B2DF8A",
"#33A02C","#FB9A99","#E31A1C",
"#FDBF6F","#FF7F00","#CAB2D6",
"#6A3D9A","#FFFF99","#B15928"))
```

# 2 OVERVIEW DATA FROM SITES
```{r between sites}

ggvenn_pq(ecm_phy, fact="site", taxonomic_rank = "Genus") 
# not working well

circle_pq(ecm_phy, "site", taxa = "Genus", add_nb_seq = F) # only 53,57% plotted
circle_pq(ecm_phy, "site", taxa = "Phylum", add_nb_seq = F,
          grid_col = "darkgrey",
          row_col = c("darkred","#1F78B4","darkgreen"))

rarecurve(t(otu_table(ps)), step=50, cex=0.5)
rarecurve(otu_table(ecm_phy), step=50, cex=0.5)
rarecurve(t(otu_table(ecm_phy)), step=50, cex=0.5)
```

=======================================================================================

# 3 HALASEN STUDY: edge retention trees
## 3.1 design and sampling
```{r overview }
# sampling design
colnames(hala_sam)
summary(hala_sam[,c(2,5:8)])
table(hala_sam$plot,hala_sam$treatment)

# nb genus
colnames(hala_ecm@tax_table)
as.factor(hala_ecm@tax_table[,5]) %>% droplevels() %>% levels() 
genus_nb_hala <- as.factor(hala_ecm@tax_table[,5]) %>% droplevels() %>% levels() %>% length()
## 23 genus
## attribution facolors, or whatever to have proper constrasted colors on graphicals representations

ggvenn_pq(hala_ecm, fact="year", taxonomic_rank = "Genus")
```

## 3.2 plotting
### 3.2.1 bivariate analysis
```{r plotting tests}
# boxplot
hala_hill_site <- hill_pq(hala_ecm, variable = "year") 
# different number of row because samples row in sam_data; and col in otu_table
hala_hill_site[[1]]+ labs(title="Hill 0 : Type de sols", subtitle="Echantillon de SOL")
hala_hill_site[[2]]+ labs(title="Hill 1 : Type de sols", subtitle="Echantillon de SOL")
hala_hill_site[[3]]+ labs(title="Hill 2 : Type de sols", subtitle="Echantillon de SOL")

# OTU Genus count (0;1) by treatment
hala_ecm_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(hala_ecm), x = "treatment") 
ggplot(hala_ecm_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment and year",subtitle = "Halasen_edge")+
  guides(fill=guide_legend(title="Genus"))
# cols25-funky palette

# OTU Genus abundance by treatment
hala_ecm_ggplot2 <- phyloseq::plot_bar(hala_ecm, x = "treatment") 
ggplot(hala_ecm_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack")+
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment and year",subtitle = "Halasen_edge")+
  guides(fill=guide_legend(title="Genus"))

```

- change between 2012 2018 -> could be explained by a difference in the biomolecular methods ? we should not expect any difference in forest control treatment between years

```{r pattern with edges}
print(hala_ecm@sam_data)
factor(hala_ecm@sam_data$specification) %>% levels()

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("edge_north"="edge", 
                             "edge_south"="edge",
                             "kant_norra"="edge", 
                             "middle_lower"="middle", 
                             "middle_upper"="middle",
                             "midle"="middle"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()

hala_ecm@sam_data <- within(hala_ecm@sam_data, specification[specification=="middle" & treatment=="forest"] <- "FOR_middle") 

hala_ecm@sam_data$specification <- plyr::revalue(hala_ecm@sam_data$specification,
                           c("middle"="CC_middle", 
                             "edge"="CC_edge"))
as.factor(hala_ecm@sam_data$specification) %>% droplevels() %>% levels()

hala_ecm_ggplot3 <- phyloseq::plot_bar(as_binary_otu_table(hala_ecm), x = "specification") 
ggplot(hala_ecm_ggplot3$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=specification, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by position from CC and year", subtitle = "Halasen_edge")+
  xlab("position from CC")+
  guides(fill=guide_legend(title="Genus"))+
  theme(axis.text.x=element_text(color="coral4", size=8, angle=20))

hala_ecm_ggplot4 <- phyloseq::plot_bar(hala_ecm, x = "specification") 
ggplot(hala_ecm_ggplot4$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=specification, y = Abundance))+
  geom_bar(stat="identity", position = "stack")+
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by position from CC and year", subtitle = "Halasen_edge")+
  xlab("position from CC")+
  guides(fill=guide_legend(title="Genus"))+
  theme(axis.text.x=element_text(color="coral4", size=8, angle=20))

hala_ecm_ordi7 <- ordinate(as_binary_otu_table(hala_ecm), method = "MDS", dist="jaccard")
plot_ordination(hala_ecm, hala_ecm_ordi7, type="samples", color="specification",label="sample_id")+
  geom_point(size=2)+
  facet_wrap(~year)+
  # color and elipse
  scale_color_manual(values = c("red","orange","darkgreen"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year", subtitle="presence-absence (jaccard distance)")

hala_ecm_ordi8 <- ordinate(hala_ecm, method = "MDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi8, type="samples", color="specification",label="sample_id")+
  geom_point(size=2)+
  facet_wrap(~year)+
  # color and elipse
  scale_color_manual(values = c("red","orange","darkgreen"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year",subtitle = "abundance (bray-curtis distance)")

hala_ecm_ordi8 <- ordinate(hala_ecm, method = "MDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi8, type="taxa", color="Order", shape="Phylum",label="sample_id")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values =cols25(10))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year",subtitle = "abundance (bray-curtis distance)")
```

```{r circle phyloseq}

circle_pq(hala_ecm, "treatment", taxa = "Genus", add_nb_seq = F)
```


```{r raref test}
data('GlobalPatterns')

psdata <- GlobalPatterns
psdata
sample_sums(psdata)
set.seed(42)

calculate_rarefaction_curves <- function(psdata, measures, depths) {
  require('plyr') # ldply
  require('reshape2') # melt

  estimate_rarified_richness <- function(psdata, measures, depth) {
    if(max(sample_sums(psdata)) < depth) return()
    psdata <- prune_samples(sample_sums(psdata) >= depth, psdata)

    rarified_psdata <- rarefy_even_depth(psdata, depth, verbose = FALSE)

    alpha_diversity <- estimate_richness(rarified_psdata, measures = measures)

    # as.matrix forces the use of melt.array, which includes the Sample names (rownames)
    molten_alpha_diversity <- melt(as.matrix(alpha_diversity), varnames = c('Sample', 'Measure'), value.name = 'Alpha_diversity')

    molten_alpha_diversity
  }

  names(depths) <- depths # this enables automatic addition of the Depth to the output by ldply
  rarefaction_curve_data <- ldply(depths, estimate_rarified_richness, psdata = psdata, measures = measures, .id = 'Depth', .progress = ifelse(interactive(), 'text', 'none'))

  # convert Depth from factor to numeric
  rarefaction_curve_data$Depth <- as.numeric(levels(rarefaction_curve_data$Depth))[rarefaction_curve_data$Depth]

  rarefaction_curve_data
}

rarefaction_curve_data <- calculate_rarefaction_curves(psdata, c('Observed', 'Shannon'), rep(c(1, 10, 100, 1000, 1:100 * 10000), each = 10))
summary(rarefaction_curve_data)

rarefaction_curve_data <- calculate_rarefaction_curves(hala_ecm, c("Observed","Shannon"), rep(c(1, 10, 100, 1000, 1:100 * 10000), each = 10))

rarefaction_curve_data_summary <- ddply(rarefaction_curve_data, c('Depth', 'Sample', 'Measure'), summarise, Alpha_diversity_mean = mean(Alpha_diversity), Alpha_diversity_sd = sd(Alpha_diversity))

rarefaction_curve_data_summary_verbose <- merge(rarefaction_curve_data_summary, data.frame(sample_data(hala_ecm)), by.x = 'Sample', by.y = 'row.names')

ggplot(
  data = rarefaction_curve_data_summary_verbose,
  mapping = aes(
    x = Depth,
    y = Alpha_diversity_mean,
    ymin = Alpha_diversity_mean - Alpha_diversity_sd,
    ymax = Alpha_diversity_mean + Alpha_diversity_sd,
    colour = treatment,
    group = Sample
  )
) + geom_line(
) + geom_pointrange(
) + facet_wrap(
  facets = ~ Measure,
  scales = 'free_y'
)
```


### 3.2.2 multivariate analysis
```{r plotting tests}
hala_ecm_ordi1 <- ordinate(as_binary_otu_table(hala_ecm), method = "MDS", dist="jaccard")
plot_ordination(hala_ecm, hala_ecm_ordi1, type="samples", color="treatment")
hala_ecm_ordi2 <- ordinate(hala_ecm, method = "MDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi2, type="samples", color="treatment")
hala_ecm_ordi2b <- ordinate(hala_ecm, method = "MDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi2b, type="samples", color="specification")

hala_ecm_ordi3 <- ordinate(as_binary_otu_table(hala_ecm), method = "NMDS", dist="jaccard")
plot_ordination(hala_ecm, hala_ecm_ordi3, type="samples", color="treatment")
hala_ecm_ordi4 <- ordinate(hala_ecm, method = "NMDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi4, type="samples", color="treatment")

hala_ecm_ordi5 <- ordinate(as_binary_otu_table(hala_ecm), method = "NMDS", dist="jaccard")
plot_ordination(hala_ecm, hala_ecm_ordi5, type="samples", color="treatment")
hala_ecm_ordi6 <- ordinate(hala_ecm, method = "NMDS", dist="bray")
plot_ordination(hala_ecm, hala_ecm_ordi6, type="samples", color="treatment")
```

=======================================================================================
# 4 HALASEN_5P STUDY: randomly distributed retention trees
## 4.1 design and sampling
```{r overview }
colnames(hala5_sam)
summary(hala5_sam[,c(2,5:8)])
summary(hala5_sam$plot)
table(hala5_sam$plot,hala5_sam$treatment)
print(hala5_ecm@sam_data)

# nb genus
colnames(hala5_ecm@tax_table)
as.factor(hala5_ecm@tax_table[,5]) %>% droplevels() %>% levels()
genus_nb_hala5 <- as.factor(hala5_ecm@tax_table[,5]) %>% droplevels() %>% levels() %>% length() # 18 genus
```

## 4.2 plotting
### 4.2.1 bivariate analysis
```{r plotting tests}
hala5_ecm_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(hala5_ecm), x = "treatment") 
ggplot(hala5_ecm_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala5))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Halasen_P5")+
  guides(fill=guide_legend(title="Genus"))

hala5_ecm_ggplot2 <- phyloseq::plot_bar(hala5_ecm, x = "treatment") 
ggplot(hala5_ecm_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala5))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment",subtitle = "Halasen_P5")+
  guides(fill=guide_legend(title="Genus"))
```

### 4.2.2 multivariate analysis
```{r plotting tests}
hala5_ecm_ordi1 <- ordinate(hala5_ecm, method = "MDS", dist="bray")
plot_ordination(hala5_ecm, hala5_ecm_ordi1, type="samples", color="treatment",label="sample_id")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values = c("red","orange","darkgreen"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="treatment"))+
  ggtitle(label = "MDS of samples from Halasen_5P",subtitle = "abundance")

hala5_ecm_ordi1 <- ordinate(as_binary_otu_table(hala5_ecm), method = "MDS", dist="jaccard")
plot_ordination(hala5_ecm, hala5_ecm_ordi1, type="samples", color="treatment",label="sample_id")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values = c("red","darkgreen","orange"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="treatment"))+
  ggtitle(label = "MDS of samples from Halasen_5P",subtitle = "abundance")

hala5_ecm_ordi1 <- ordinate(as_binary_otu_table(hala5_ecm), method = "NMDS", dist="jaccard",k=20)
plot_ordination(hala5_ecm, hala5_ecm_ordi1, type="samples", color="treatment",label="sample_id")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values = c("red","darkgreen","orange"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="treatment"))+
  ggtitle(label = "MDS of samples from Halasen_5P",subtitle = "abundance")

hala5_ecm_ordi_phyl1 <- ordinate(hala5_ecm, method = "MDS", dist="bray")
plot_ordination(hala5_ecm, hala5_ecm_ordi_phyl1, type="taxa", color="Order", shape="Phylum")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values =cols25(10))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year",subtitle = "abundance (bray-curtis distance)")


```

=======================================================================================

# 5 FANGAMON STUDY: randomly distributed retention trees

## 5.1 design and sampling
```{r overview }
colnames(fanga_sam)
summary(fanga_sam[,c(2,5:8)])
summary(fanga_sam$plot)
table(fanga_sam$plot,fanga_sam$treatment)

# nb genus
colnames(fanga_ecm@tax_table)
as.factor(fanga_ecm@tax_table[,5]) %>% droplevels() %>% levels()
genus_nb_fanga <- as.factor(fanga_ecm@tax_table[,5]) %>% droplevels() %>% levels() %>% length() # 16 genus
```

## 5.2 plotting
### 5.2.1 bivariate analysis
```{r plotting tests}
fanga_ecm_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(fanga_ecm), x = "treatment") 
ggplot(fanga_ecm_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Fangamon")+
  guides(fill=guide_legend(title="Genus"))

fanga_ecm_ggplot2 <- phyloseq::plot_bar(fanga_ecm, x = "treatment") 
ggplot(fanga_ecm_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment",subtitle = "Fangamon")+
  guides(fill=guide_legend(title="Genus"))

# position = fill -> relative abundance 
```

```{r trying understand difference between boolean and relative abundance}
fanga_ecm_only_cc <- subset_samples(fanga_ecm, fanga_ecm@sam_data$treatment=="clearcut") %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)

print(fanga_ecm_only_cc@otu_table)
which(fanga_ecm_only_cc@otu_table>200,arr.ind = T) %>% rownames() 
fanga_ecm_only_cc@tax_table[c("c10", "c21"),6] # 2 super abundant species 
```

```{r maybe a contamination for a sample?}
fanga_ecm_only_cc_2012 <- subset_samples(fanga_ecm, fanga_ecm@sam_data$year=="2012" & fanga_ecm@sam_data$treatment=="clearcut") %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)
print(fanga_ecm_only_cc_2012@sam_data)
print(fanga_ecm_only_cc_2012@otu_table) # c10 in both samples, c21 in another different one... no specific contamination it seems

fanga_ecm_excl_samples <- subset_samples(fanga_ecm, !fanga_ecm@sam_data$sample_id %in% c("s152","s45")) %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)

fanga_ecm_ggplot3 <- phyloseq::plot_bar(as_binary_otu_table(fanga_ecm_excl_samples), x = "treatment") 
ggplot(fanga_ecm_ggplot3$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Fangamon- exlcuded s152,s45 samples")+
  guides(fill=guide_legend(title="Genus"))

fanga_ecm_ggplot2 <- phyloseq::plot_bar(fanga_ecm_excl_samples, x = "treatment") 
ggplot(fanga_ecm_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  labs(title="", subtitle="")  
```

### 5.2.2 multivariate analysis
```{r plotting tests}
fanga_ecm_ordi1 <- ordinate(as_binary_otu_table(fanga_ecm), method = "MDS", dist="jaccard")
plot_ordination(fanga_ecm, fanga_ecm_ordi1, type="samples", color="treatment")
fanga_ecm_ordi2 <- ordinate(fanga_ecm, method = "MDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi2, type="samples", color="treatment")
fanga_ecm_ordi2b <- ordinate(fanga_ecm, method = "MDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi2b, type="samples", color="specification")

fanga_ecm_ordi3 <- ordinate(as_binary_otu_table(fanga_ecm), method = "NMDS", dist="jaccard")
plot_ordination(fanga_ecm, fanga_ecm_ordi3, type="samples", color="treatment")
fanga_ecm_ordi4 <- ordinate(fanga_ecm, method = "NMDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi4, type="samples", color="treatment")

fanga_ecm_ordi5 <- ordinate(as_binary_otu_table(fanga_ecm), method = "NMDS", dist="jaccard")
plot_ordination(fanga_ecm, fanga_ecm_ordi5, type="samples", color="treatment")
fanga_ecm_ordi6 <- ordinate(fanga_ecm, method = "NMDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi6, type="samples", color="treatment")

fanga_ecm_ordi_phyl1 <- ordinate(fanga_ecm, method = "MDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi_phyl1, type="taxa", color="Order", shape="Phylum")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values =cols25(10))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year",subtitle = "abundance (bray-curtis distance)")

fanga_ecm_ordi_phyl1 <- ordinate(fanga_ecm, method = "MDS", dist="bray")
plot_ordination(fanga_ecm, fanga_ecm_ordi_phyl1, type="samples", color="sample_id", shape="treatment")+
  geom_point(size=2)+
  # color and elipse
  scale_color_manual(values =cols25(55))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))+
  ggtitle(label = "MDS of samples from Halasen_edge by year",subtitle = "abundance (bray-curtis distance)")
```
