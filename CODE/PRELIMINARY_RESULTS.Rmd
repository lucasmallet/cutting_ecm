---
title: "PRELIMINARY_RESULTS"
output: html_document
date: "2023-03-08"
---
```{r libraries}
library(plyr)
```

```{r color palette}
library(pals)
pal.bands(alphabet, alphabet2, cols25, glasbey, kelly, polychrome, 
  stepped, tol, watlington,
  show.names=FALSE)

funky <- colorRampPalette(c("#A6CEE3","#1F78B4","#B2DF8A",
"#33A02C","#FB9A99","#E31A1C",
"#FDBF6F","#FF7F00","#CAB2D6",
"#6A3D9A","#FFFF99","#B15928"))
```

=======================================================================================
-------------------------------------
# 1 HALASEN STUDY: edge retention trees
-------------------------------------
# design and sampling
```{r overview }
# sampling design
colnames(hala_sam)
summary(hala_sam[,c(2,5:8)])
table(hala_sam$plot,hala_sam$treatment)

# nb genus
colnames(ecm_hala@tax_table)
as.factor(ecm_hala@tax_table[,5]) %>% droplevels() %>% levels() 
genus_nb_hala <- as.factor(ecm_hala@tax_table[,5]) %>% droplevels() %>% levels() %>% length()
# 23 genus
# attribution facolors, or whatever to have proper constrasted colors on graphicals representations
```

# plotting
## bivariate analysis
```{r plotting tests}
ecm_hala_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(ecm_hala), x = "treatment") 
ggplot(ecm_hala_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment and year",subtitle = "Halasen_edge")+
  guides(fill=guide_legend(title="Genus"))
# cols25-funky palette

ecm_hala_ggplot2 <- phyloseq::plot_bar(ecm_hala, x = "treatment") 
ggplot(ecm_hala_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack")+
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment and year",subtitle = "Halasen_edge")+
  guides(fill=guide_legend(title="Genus"))
# position = fill -> relative abundance 
```

- change between 2012 2018 -> could be explained by a difference in the biomolecular methods ? we should not expect any difference in forest control treatment between years

```{r pattern with edges}
print(ecm_hala@sam_data)
factor(ecm_hala@sam_data$specification) %>% levels()

ecm_hala@sam_data$specification <- plyr::revalue(ecm_hala@sam_data$specification,
                           c("edge_north"="edge", 
                             "edge_south"="edge",
                             "kant_norra"="edge", 
                             "middle_lower"="middle", 
                             "middle_upper"="middle",
                             "midle"="middle"))
as.factor(ecm_hala@sam_data$specification) %>% droplevels() %>% levels()

ecm_hala@sam_data <- within(ecm_hala@sam_data, specification[specification=="middle" & treatment=="forest"] <- "FOR_middle") 

ecm_hala@sam_data$specification <- plyr::revalue(ecm_hala@sam_data$specification,
                           c("middle"="CC_middle", 
                             "edge"="CC_edge"))
as.factor(ecm_hala@sam_data$specification) %>% droplevels() %>% levels()

ecm_hala_ggplot3 <- phyloseq::plot_bar(as_binary_otu_table(ecm_hala), x = "specification") 
ggplot(ecm_hala_ggplot3$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=specification, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by position from CC and year", subtitle = "Halasen_edge")+
  xlab("position from CC")+
  guides(fill=guide_legend(title="Genus"))+
  theme(axis.text.x=element_text(color="coral4", size=8, angle=20))

ecm_hala_ggplot4 <- phyloseq::plot_bar(ecm_hala, x = "specification") 
ggplot(ecm_hala_ggplot4$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=specification, y = Abundance))+
  geom_bar(stat="identity", position = "stack")+
  scale_fill_manual(values = cols25(genus_nb_hala))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by position from CC and year", subtitle = "Halasen_edge")+
  xlab("position from CC")+
  guides(fill=guide_legend(title="Genus"))+
  theme(axis.text.x=element_text(color="coral4", size=8, angle=20))

ecm_hala_ordi7 <- ordinate(as_binary_otu_table(ecm_hala), method = "MDS", dist="jaccard")
plot_ordination(ecm_hala, ecm_hala_ordi7, type="samples", color="specification",label="sample_id")+
  geom_point(size=2)+
  facet_wrap(~year)+
  # color and elipse
  scale_color_manual(values = c("red","orange","darkgreen"))+
  stat_ellipse(type="t", level=0.70)+
  # legend
  guides(color=guide_legend(title="position from CC"))
```

```{r raref test}
data('GlobalPatterns')

psdata <- GlobalPatterns
psdata
sample_sums(psdata)
set.seed(42)

calculate_rarefaction_curves <- function(psdata, measures, depths) {
  require('plyr') # ldply
  require('reshape2') # melt

  estimate_rarified_richness <- function(psdata, measures, depth) {
    if(max(sample_sums(psdata)) < depth) return()
    psdata <- prune_samples(sample_sums(psdata) >= depth, psdata)

    rarified_psdata <- rarefy_even_depth(psdata, depth, verbose = FALSE)

    alpha_diversity <- estimate_richness(rarified_psdata, measures = measures)

    # as.matrix forces the use of melt.array, which includes the Sample names (rownames)
    molten_alpha_diversity <- melt(as.matrix(alpha_diversity), varnames = c('Sample', 'Measure'), value.name = 'Alpha_diversity')

    molten_alpha_diversity
  }

  names(depths) <- depths # this enables automatic addition of the Depth to the output by ldply
  rarefaction_curve_data <- ldply(depths, estimate_rarified_richness, psdata = psdata, measures = measures, .id = 'Depth', .progress = ifelse(interactive(), 'text', 'none'))

  # convert Depth from factor to numeric
  rarefaction_curve_data$Depth <- as.numeric(levels(rarefaction_curve_data$Depth))[rarefaction_curve_data$Depth]

  rarefaction_curve_data
}

rarefaction_curve_data <- calculate_rarefaction_curves(psdata, c('Observed', 'Shannon'), rep(c(1, 10, 100, 1000, 1:100 * 10000), each = 10))
summary(rarefaction_curve_data)

rarefaction_curve_data <- calculate_rarefaction_curves(ecm_hala, c("Observed","Shannon"), rep(c(1, 10, 100, 1000, 1:100 * 10000), each = 10))

rarefaction_curve_data_summary <- ddply(rarefaction_curve_data, c('Depth', 'Sample', 'Measure'), summarise, Alpha_diversity_mean = mean(Alpha_diversity), Alpha_diversity_sd = sd(Alpha_diversity))

rarefaction_curve_data_summary_verbose <- merge(rarefaction_curve_data_summary, data.frame(sample_data(ecm_hala)), by.x = 'Sample', by.y = 'row.names')

ggplot(
  data = rarefaction_curve_data_summary_verbose,
  mapping = aes(
    x = Depth,
    y = Alpha_diversity_mean,
    ymin = Alpha_diversity_mean - Alpha_diversity_sd,
    ymax = Alpha_diversity_mean + Alpha_diversity_sd,
    colour = treatment,
    group = Sample
  )
) + geom_line(
) + geom_pointrange(
) + facet_wrap(
  facets = ~ Measure,
  scales = 'free_y'
)
```


## multivariate analysis
```{r plotting tests}
ecm_hala_ordi1 <- ordinate(as_binary_otu_table(ecm_hala), method = "MDS", dist="jaccard")
plot_ordination(ecm_hala, ecm_hala_ordi1, type="samples", color="treatment")
ecm_hala_ordi2 <- ordinate(ecm_hala, method = "MDS", dist="bray")
plot_ordination(ecm_hala, ecm_hala_ordi2, type="samples", color="treatment")
ecm_hala_ordi2b <- ordinate(ecm_hala, method = "MDS", dist="bray")
plot_ordination(ecm_hala, ecm_hala_ordi2b, type="samples", color="specification")

ecm_hala_ordi3 <- ordinate(as_binary_otu_table(ecm_hala), method = "NMDS", dist="jaccard")
plot_ordination(ecm_hala, ecm_hala_ordi3, type="samples", color="treatment")
ecm_hala_ordi4 <- ordinate(ecm_hala, method = "NMDS", dist="bray")
plot_ordination(ecm_hala, ecm_hala_ordi4, type="samples", color="treatment")

ecm_hala_ordi5 <- ordinate(as_binary_otu_table(ecm_hala), method = "NMDS", dist="jaccard")
plot_ordination(ecm_hala, ecm_hala_ordi5, type="samples", color="treatment")
ecm_hala_ordi6 <- ordinate(ecm_hala, method = "NMDS", dist="bray")
plot_ordination(ecm_hala, ecm_hala_ordi6, type="samples", color="treatment")
```

=======================================================================================
------------------------------------------------------
# 2 HALASEN_5P STUDY: randomly distributed retention trees
------------------------------------------------------
# design and sampling
```{r overview }
colnames(hala5_sam)
summary(hala5_sam[,c(2,5:8)])
summary(hala5_sam$plot)
table(hala5_sam$plot,hala5_sam$treatment)
print(ecm_hala5@sam_data)

# nb genus
colnames(ecm_hala5@tax_table)
as.factor(ecm_hala5@tax_table[,5]) %>% droplevels() %>% levels()
genus_nb_hala5 <- as.factor(ecm_hala5@tax_table[,5]) %>% droplevels() %>% levels() %>% length() # 18 genus
```

# plotting
## bivariate analysis
```{r plotting tests}
ecm_hala5_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(ecm_hala5), x = "treatment") 
ggplot(ecm_hala5_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala5))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Halasen_P5")+
  guides(fill=guide_legend(title="Genus"))

ecm_hala5_ggplot2 <- phyloseq::plot_bar(ecm_hala5, x = "treatment") 
ggplot(ecm_hala5_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  scale_fill_manual(values = cols25(genus_nb_hala5))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment",subtitle = "Halasen_P5")+
  guides(fill=guide_legend(title="Genus"))
```

## multivariate analysis
```{r plotting tests}
ecm_hala5_ordi1 <- ordinate(as_binary_otu_table(ecm_hala5), method = "MDS", dist="jaccard")
plot_ordination(ecm_hala5, ecm_hala5_ordi1, type="samples", color="treatment")
ecm_hala5_ordi2 <- ordinate(ecm_hala5, method = "MDS", dist="bray")
plot_ordination(ecm_hala5, ecm_hala5_ordi2, type="samples", color="treatment")
ecm_hala5_ordi2b <- ordinate(ecm_hala5, method = "MDS", dist="bray")
plot_ordination(ecm_hala5, ecm_hala5_ordi2b, type="samples", color="specification")

ecm_hala5_ordi3 <- ordinate(as_binary_otu_table(ecm_hala5), method = "NMDS", dist="jaccard")
plot_ordination(ecm_hala5, ecm_hala5_ordi3, type="samples", color="treatment")
ecm_hala5_ordi4 <- ordinate(ecm_hala5, method = "NMDS", dist="bray")
plot_ordination(ecm_hala5, ecm_hala5_ordi4, type="samples", color="treatment")

ecm_hala5_ordi5 <- ordinate(as_binary_otu_table(ecm_hala5), method = "NMDS", dist="jaccard")
plot_ordination(ecm_hala5, ecm_hala5_ordi5, type="samples", color="treatment")
ecm_hala5_ordi6 <- ordinate(ecm_hala5, method = "NMDS", dist="bray")
plot_ordination(ecm_hala5, ecm_hala5_ordi6, type="samples", color="treatment")
```
=======================================================================================
------------------------------------------------------
# 3 FANGAMON STUDY: randomly distributed retention trees
------------------------------------------------------
# design and sampling
```{r overview }
colnames(fanga_sam)
summary(fanga_sam[,c(2,5:8)])
summary(fanga_sam$plot)
table(fanga_sam$plot,fanga_sam$treatment)

# nb genus
colnames(ecm_fanga@tax_table)
as.factor(ecm_fanga@tax_table[,5]) %>% droplevels() %>% levels()
genus_nb_fanga <- as.factor(ecm_fanga@tax_table[,5]) %>% droplevels() %>% levels() %>% length() # 16 genus
```

# plotting
## bivariate analysis
```{r plotting tests}
ecm_fanga_ggplot1 <- phyloseq::plot_bar(as_binary_otu_table(ecm_fanga), x = "treatment") 
ggplot(ecm_fanga_ggplot1$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Fangamon")+
  guides(fill=guide_legend(title="Genus"))

ecm_fanga_ggplot2 <- phyloseq::plot_bar(ecm_fanga, x = "treatment") 
ggplot(ecm_fanga_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus abundance by cutting treatment",subtitle = "Fangamon")+
  guides(fill=guide_legend(title="Genus"))

# position = fill -> relative abundance 
```

```{r trying understand difference between boolean and relative abundance}
ecm_fanga_only_cc <- subset_samples(ecm_fanga, ecm_fanga@sam_data$treatment=="clearcut") %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)

print(ecm_fanga_only_cc@otu_table)
which(ecm_fanga_only_cc@otu_table>200,arr.ind = T) %>% rownames() 
ecm_fanga_only_cc@tax_table[c("c10", "c21"),6] # 2 super abundant species 
```

```{r maybe a contamination for a sample?}
ecm_fanga_only_cc_2012 <- subset_samples(ecm_fanga, ecm_fanga@sam_data$year=="2012" & ecm_fanga@sam_data$treatment=="clearcut") %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)
print(ecm_fanga_only_cc_2012@sam_data)
print(ecm_fanga_only_cc_2012@otu_table) # c10 in both samples, c21 in another different one... no specific contamination it seems

ecm_fanga_excl_samples <- subset_samples(ecm_fanga, !ecm_fanga@sam_data$sample_id %in% c("s152","s45")) %>% clean_physeq(remove_empty_samples = T,remove_empty_taxa = T)

ecm_fanga_ggplot3 <- phyloseq::plot_bar(as_binary_otu_table(ecm_fanga_excl_samples), x = "treatment") 
ggplot(ecm_fanga_ggplot3$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  scale_fill_manual(values = cols25(genus_nb_fanga))+
  facet_grid(~year, scale="free")+
  labs(title="OTU Genus count (0;1) by cutting treatment",subtitle = "Fangamon- exlcuded s152,s45 samples")+
  guides(fill=guide_legend(title="Genus"))

ecm_fanga_ggplot2 <- phyloseq::plot_bar(ecm_fanga_excl_samples, x = "treatment") 
ggplot(ecm_fanga_ggplot2$data, aes(fill= fct_reorder(as.factor(Genus), Abundance), x=treatment, y = Abundance))+
  geom_bar(stat="identity", position = "stack") +
  facet_grid(~year, scale="free")+
  labs(title="", subtitle="")  
```

## multivariate analysis
```{r plotting tests}
ecm_fanga_ordi1 <- ordinate(as_binary_otu_table(ecm_fanga), method = "MDS", dist="jaccard")
plot_ordination(ecm_fanga, ecm_fanga_ordi1, type="samples", color="treatment")
ecm_fanga_ordi2 <- ordinate(ecm_fanga, method = "MDS", dist="bray")
plot_ordination(ecm_fanga, ecm_fanga_ordi2, type="samples", color="treatment")
ecm_fanga_ordi2b <- ordinate(ecm_fanga, method = "MDS", dist="bray")
plot_ordination(ecm_fanga, ecm_fanga_ordi2b, type="samples", color="specification")

ecm_fanga_ordi3 <- ordinate(as_binary_otu_table(ecm_fanga), method = "NMDS", dist="jaccard")
plot_ordination(ecm_fanga, ecm_fanga_ordi3, type="samples", color="treatment")
ecm_fanga_ordi4 <- ordinate(ecm_fanga, method = "NMDS", dist="bray")
plot_ordination(ecm_fanga, ecm_fanga_ordi4, type="samples", color="treatment")

ecm_fanga_ordi5 <- ordinate(as_binary_otu_table(ecm_fanga), method = "NMDS", dist="jaccard")
plot_ordination(ecm_fanga, ecm_fanga_ordi5, type="samples", color="treatment")
ecm_fanga_ordi6 <- ordinate(ecm_fanga, method = "NMDS", dist="bray")
plot_ordination(ecm_fanga, ecm_fanga_ordi6, type="samples", color="treatment")
```
